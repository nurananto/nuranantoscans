name: Auto Update Manga Covers (R2)

on:
  schedule:
    - cron: '0 0 */14 * *'  # Every 14 days
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-covers:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ”§ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ðŸ“¥ Install Dependencies
        run: |
          echo "[INFO] Installing sharp & AWS SDK for R2..."
          npm install sharp @aws-sdk/client-s3
      
      - name: â˜ï¸ Download & Upload Covers to R2
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_ACCESS_KEY_ID: ${{ secrets.CF_ACCESS_KEY_ID }}
          CF_SECRET_ACCESS_KEY: ${{ secrets.CF_SECRET_ACCESS_KEY }}
          R2_PUBLIC_DOMAIN: ${{ secrets.R2_PUBLIC_DOMAIN }}
        run: |
          echo "[START] Starting cover update process (with R2 upload)..."
          node download-covers-r2.js
        continue-on-error: false
      
      - name: ðŸ“ Check for Changes
        id: check_changes
        run: |
          if [[ -n $(git status -s manga-config.js repo-list.txt) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "[SUCCESS] Ada perubahan cover terdeteksi"
            git status -s
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "[INFO] Tidak ada perubahan cover"
          fi
      
      - name: ðŸ’¾ Commit and Push Changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add manga-config.js repo-list.txt
          
          COMMIT_MSG="ðŸ¤– Auto-update covers (R2) - $(date +'%Y-%m-%d')"
          git commit -m "$COMMIT_MSG" || exit 0
          
          git push
      
      - name: ðŸ“¤ Trigger Sync to Manga Repos (Auto-detect)
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          set +e  # Don't exit on error
          
          echo "[INFO] Reading repo list from repo-list.txt..."
          
          if [ ! -f "repo-list.txt" ]; then
            echo "[ERROR] repo-list.txt not found!"
            exit 1
          fi
          
          repo_count=$(wc -l < repo-list.txt)
          echo "[INFO] Found $repo_count repos"
          
          success=0
          failed=0
          skipped=0
          
          while IFS= read -r repo; do
            if [ -z "$repo" ]; then
              continue
            fi
            
            echo "[TRIGGER] Triggering $repo..."
            
            # Use separate variable for HTTP code to avoid pipeline issues
            http_code=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
              https://api.github.com/repos/nurananto/$repo/dispatches \
              -d '{"event_type":"sync-covers"}' 2>&1 || echo "000")
            
            if [ "$http_code" = "204" ]; then
              echo "  [SUCCESS] $repo triggered"
              ((success++))
            elif [ "$http_code" = "404" ]; then
              echo "  [WARN] $repo not found or workflow missing (HTTP 404)"
              echo "        Make sure sync-cover.yml is uploaded to this repo"
              ((skipped++))
            elif [ "$http_code" = "000" ]; then
              echo "  [ERROR] $repo failed (network error)"
              ((failed++))
            else
              echo "  [ERROR] $repo failed (HTTP $http_code)"
              ((failed++))
            fi
            
            sleep 1
          done < repo-list.txt
          
          echo ""
          echo "========================================"
          echo "[TRIGGER SUMMARY]"
          echo "  [SUCCESS] $success repos"
          echo "  [WARN] $skipped repos (workflow missing)"
          echo "  [FAILED] $failed repos"
          echo "  [TOTAL] $repo_count repos"
          echo "========================================"
          
          # Exit with success even if some repos failed
          # (main cover upload was successful)
          if [ $success -gt 0 ]; then
            echo ""
            echo "[INFO] At least $success repos triggered successfully"
            exit 0
          elif [ $skipped -gt 0 ]; then
            echo ""
            echo "[WARN] No repos triggered, but $skipped repos need sync-cover.yml"
            exit 0
          else
            echo ""
            echo "[ERROR] All trigger attempts failed"
            exit 1
          fi
      
      - name: âœ… Success Notification
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo ""
          echo "========================================"
          echo "[COMPLETE] Cover update process finished!"
          echo "  â˜ï¸  Covers uploaded to Cloudflare R2"
          echo "  ðŸ—‘ï¸  Old covers auto-deleted from R2"
          echo "  ðŸ“¤ Sync triggers sent to all manga repos"
          echo "========================================"
          echo ""
      
      - name: â„¹ï¸ No Changes Notification
        if: steps.check_changes.outputs.has_changes == 'false'
        run: |
          echo ""
          echo "========================================"
          echo "[INFO] All covers are already up-to-date!"
          echo "  â„¹ï¸  No changes made"
          echo "========================================"
          echo ""