name: Auto Version & Cache Bust

on:
  # âœ… HANYA bisa dipanggil dari workflow lain atau manual
  workflow_call:
  
  # Manual trigger untuk testing
  workflow_dispatch:

permissions:
  contents: write

jobs:
  version-bump:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ”§ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¢ Generate Version from Commit Hash
        id: version
        run: |
          VERSION=$(git rev-parse --short HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ New version: $VERSION"
      
      - name: ğŸ“ Update Version File
        run: |
          VERSION=${{ steps.version.outputs.version }}
          
          # Create/Update version.txt with new version
          echo "$VERSION" > version.txt
          
          echo "âœ… Version file updated: $VERSION"
      
      - name: ğŸ”„ Update Service Worker Cache Version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          
          # Update sw.js - ganti CACHE_NAME dengan version baru
          sed -i "s/const CACHE_NAME = 'nurananto-v[0-9a-f]*'/const CACHE_NAME = 'nurananto-v$VERSION'/g" sw.js
          sed -i "s/const STATIC_CACHE = 'static-v[0-9a-f]*'/const STATIC_CACHE = 'static-v$VERSION'/g" sw.js
          sed -i "s/const IMAGE_CACHE = 'images-v[0-9a-f]*'/const IMAGE_CACHE = 'images-v$VERSION'/g" sw.js
          sed -i "s/const DYNAMIC_CACHE = 'dynamic-v[0-9a-f]*'/const DYNAMIC_CACHE = 'dynamic-v$VERSION'/g" sw.js
          
          echo "âœ… Service Worker updated to version: $VERSION"
      
      - name: ğŸ¨ Add Cache Busting to HTML Files
        run: |
          VERSION=${{ steps.version.outputs.version }}
          
          # Update semua HTML files dengan query string version
          for file in index.html info-manga.html reader.html; do
            if [ -f "$file" ]; then
              # CSS files - gunakan positive lookbehind yang lebih spesifik
              sed -i "s|\([\"']\)style\.css\?v=[^\"']*|\1style.css?v=$VERSION|g" $file
              sed -i "s|\([\"']\)info-manga\.css\?v=[^\"']*|\1info-manga.css?v=$VERSION|g" $file
              sed -i "s|\([\"']\)reader\.css\?v=[^\"']*|\1reader.css?v=$VERSION|g" $file
              
              # âœ… FIX: JS files - hanya update yang ada attribute src=
              # Tidak akan touch baris yang di-comment
              sed -i "s|src=\"script\.js\?v=[^\"]*\"|src=\"script.js?v=$VERSION\"|g" $file
              sed -i "s|src=\"info-manga\.js\?v=[^\"]*\"|src=\"info-manga.js?v=$VERSION\"|g" $file
              sed -i "s|src=\"reader\.js\?v=[^\"]*\"|src=\"reader.js?v=$VERSION\"|g" $file
              sed -i "s|src=\"manga-config\.js\?v=[^\"]*\"|src=\"manga-config.js?v=$VERSION\"|g" $file
              sed -i "s|src=\"auto-reload\.js\?v=[^\"]*\"|src=\"auto-reload.js?v=$VERSION\"|g" $file
              
              # SW registration
              sed -i "s|sw\.js\?v=[^\"']*|sw.js?v=$VERSION|g" $file
              
              # HTML files (navigasi antar halaman)
              sed -i "s|index\.html\?v=[^\"']*|index.html?v=$VERSION|g" $file
              sed -i "s|info-manga\.html\?v=[^\"']*|info-manga.html?v=$VERSION|g" $file
              sed -i "s|reader\.html\?v=[^\"']*|reader.html?v=$VERSION|g" $file
              
              echo "âœ… Updated: $file"
            fi
          done
      
      - name: ğŸ” Check for Changes
        id: check_changes
        run: |
          git diff --quiet || echo "has_changes=true" >> $GITHUB_OUTPUT
      
      - name: ğŸ’¾ Commit Version Update
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          git add version.txt sw.js index.html info-manga.html reader.html
          git commit -m "ğŸ”„ Auto-version: v${{ steps.version.outputs.version }} [skip ci]"
          git push
          
          echo "âœ… Version bump committed!"
      
      - name: ğŸ—‘ï¸ Purge Cloudflare Cache
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          if [ -n "${{ secrets.CF_ZONE_ID }}" ] && [ -n "${{ secrets.CF_API_TOKEN }}" ]; then
            response=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
              -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}')
            
            echo "ğŸŒ Cloudflare Response: $response"
            echo "âœ… Cache purged!"
          else
            echo "âš ï¸ Cloudflare credentials not found, skipping purge"
          fi
