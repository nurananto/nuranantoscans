<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Content Security Policy - Bank-Grade Protection -->
    <!-- CSP Reporting: To enable violation reports, add report-uri https://your-endpoint.com/csp-report -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                   script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://api.anthropic.com https://accounts.google.com; 
                   style-src 'self' 'unsafe-inline' https://accounts.google.com; 
                   img-src 'self' data: https:; 
                   font-src 'self' data:; 
                   connect-src 'self' 
                     https://manga-view-counter.nuranantoadhien.workers.dev
                     https://manga-auth-worker.nuranantoadhien.workers.dev 
                     https://manga-code-validator.nuranantoadhien.workers.dev 
                     https://decrypt-manifest.nuranantoadhien.workers.dev
                     https://profile-worker.nuranantoadhien.workers.dev
                     https://cdn.jsdelivr.net
                     https://accounts.google.com
                     https://oauth2.googleapis.com
                     https://unpkg.com
                     https://cdnjs.cloudflare.com
                     https://script.google.com 
                     https://*.googleusercontent.com 
                     https://raw.githubusercontent.com 
                     https://images.weserv.nl
                     https://api.anthropic.com;
                   form-action 'self' https://manga-auth-worker.nuranantoadhien.workers.dev;
                   frame-src https://accounts.google.com;
                   frame-ancestors 'none';
                   upgrade-insecure-requests;
                   base-uri 'self';">
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=(), payment=(), usb=(), identity-credentials-get=(self)">
    <!-- HSTS: Strict-Transport-Security configured in _headers file -->
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <meta name="description" content="Baca komik dan manga terbaru dari Nurananto Scanlation">
    <meta name="keywords" content="manga, komik, scanlation, baca online">
    <meta name="author" content="Nurananto Scanlation">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Nurananto Scanlation">
    <meta name="theme-color" content="#0a0a0a">
    <title>Loading...</title>
    
    <!-- Preload Critical Fonts -->
    <link rel="preload" 
          href="fonts/roboto-v50-latin-regular.woff2" 
          as="font" 
          type="font/woff2" 
          crossorigin>
    <link rel="preload" 
          href="fonts/roboto-v50-latin-500.woff2" 
          as="font" 
          type="font/woff2" 
          crossorigin>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="fonts.css?v=4b51f1b">
    <link rel="stylesheet" href="info-manga.css?v=3.2.1">
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://raw.githubusercontent.com">
    <link rel="dns-prefetch" href="https://raw.githubusercontent.com">
    <link rel="preconnect" href="https://images.weserv.nl">
    <link rel="dns-prefetch" href="https://images.weserv.nl">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/Webicon/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="assets/Webicon/favicon.svg">
    <link rel="icon" type="image/png" sizes="96x96" href="assets/Webicon/favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/Webicon/apple-touch-icon.png">
    <meta name="theme-color" content="#1e90ff">
    
    <!-- Critical CSS -->
    <style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Roboto','Segoe UI','Helvetica Neue',Arial,sans-serif;background-color:#0a0a0a;color:#e4e6eb;padding:20px;line-height:1.6;padding-bottom:100px}header{max-width:1400px;margin:0 auto 1.5rem;padding:0 0}.header-content{display:flex;justify-content:space-between;align-items:center}.site-logo{height:60px;width:auto}.header-buttons{display:flex;gap:12px}.github-link-header,.facebook-link-header{display:flex;align-items:center;gap:8px;padding:8px 16px;border-radius:8px;text-decoration:none}.github-link-header{background:#24292e}.facebook-link-header{background:#1877f2}.github-icon,.facebook-icon{width:24px;height:24px}.github-text,.facebook-text{color:#fff;font-weight:600;font-size:14px}.container{max-width:1400px;margin:0 auto;display:grid;grid-template-columns:320px 1fr;gap:20px}.cover-container{position:relative;width:100%}.manga-cover{width:100%;height:auto;display:block;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.7);contain-intrinsic-size:320px 453px}.title-section-mobile{display:none}.title-section-desktop{display:block}.main-title{font-size:clamp(28px,5vw,42px);font-weight:700;color:#fff;margin-bottom:10px;line-height:1.2;word-wrap:break-word}.subtitle{font-size:clamp(16px,3vw,20px);color:#b0b0b0;margin-bottom:8px;line-height:1.4}.badges-container{display:inline-flex;flex-direction:row;gap:12px;align-items:center;margin-bottom:15px}.views-badge,.rating-badge{height:46px;border:none;border-radius:6px;padding:0 20px;display:flex;align-items:center;justify-content:center;gap:8px}.views-badge{background-color:#dc143c}.rating-badge{background-color:#1877f2}.views-number,.rating-number{font-weight:700;font-size:18px;color:#fff}.star-icon{width:20px;height:20px}.btn-show-details{width:100%;background-color:#5865F2;color:#fff;border:none;padding:12px 20px;font-size:15px;font-weight:600;cursor:pointer;border-radius:6px;display:none;margin-top:10px}.btn-read-first{width:100%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:14px 20px;font-size:15px;font-weight:700;cursor:pointer;border-radius:6px;text-transform:uppercase;letter-spacing:1px;display:flex;align-items:center;justify-content:center;gap:10px;box-shadow:0 4px 15px rgba(102,126,234,0.4)}.btn-read-outside{display:none}.btn-read-inside{display:flex}.info-box{background-color:#2a2a2a;border:1px solid #3a3a3a;border-radius:4px;padding:12px 20px}.external-links-container{display:grid;grid-template-columns:1fr 1fr;gap:10px}.sidebar-btn{background-color:#242526;color:#fff;border:1px solid #3a3a3a;padding:10px 16px;font-size:14px;font-weight:600;cursor:pointer;border-radius:6px}.description-box,.chapters-box{background-color:#18191a;border:1px solid #2f3336;border-radius:8px;padding:20px;margin-bottom:20px}.section-title{font-size:20px;font-weight:700;color:#fff;margin-bottom:15px;text-transform:uppercase}.trakteer-button{position:fixed;bottom:30px;left:24px;right:24px;z-index:1000;display:flex;align-items:center;justify-content:center;gap:10px;background:linear-gradient(135deg,#be1e2d 0%,#d32f2f 100%);padding:12px 20px;border-radius:16px;text-decoration:none;color:#fff;font-weight:700}.visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}.skip-link{position:absolute;top:-40px;left:0;background:#1877f2;color:#fff;padding:8px 16px;text-decoration:none;z-index:100;border-radius:0 0 4px 0}.skip-link:focus{top:0}@media(max-width:768px){body{padding:20px;padding-bottom:110px}.container{grid-template-columns:1fr;gap:5px}header{margin-bottom:1rem}.site-logo{height:45px}.header-buttons{gap:8px}.github-link-header,.facebook-link-header{height:45px;width:45px;min-width:45px;min-height:45px;padding:0;border-radius:10px}.github-icon,.facebook-icon{width:24px;height:24px}.github-text,.facebook-text{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}.title-section-desktop{display:none}.title-section-mobile{display:block;text-align:center}.btn-show-details{display:flex}.btn-read-outside{display:flex}.btn-read-inside{display:none}.main-title{font-size:clamp(22px,6vw,28px)}.subtitle{font-size:clamp(14px,4vw,16px)}}.modal-overlay{display:none}</style>

    <!-- Edit Profile Modal Styles -->
    <style>
/* ============================================
   EDIT PROFILE MODAL STYLES
   ============================================ */
.profile-username-container {
    position: relative;
    display: inline-block;
    margin: 0 0 12px 0;
}

.profile-username {
    margin: 0 !important;
    line-height: 1.2;
}

.btn-edit-profile {
    position: absolute;
    right: -35px;
    top: 0;
    bottom: 0;
    margin: auto 0;
    height: 24px;
    background: transparent;
    border: none;
    padding: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.8;
}

.btn-edit-profile:hover {
    opacity: 1;
    transform: scale(1.15);
}

.btn-edit-profile svg {
    stroke: #ffd700;
    filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.8))
            drop-shadow(0 0 8px rgba(255, 215, 0, 0.6))
            drop-shadow(0 0 12px rgba(255, 215, 0, 0.4));
    animation: pencilGlow 2s ease-in-out infinite;
}

.btn-edit-profile:hover svg {
    filter: drop-shadow(0 0 6px rgba(255, 215, 0, 1))
            drop-shadow(0 0 12px rgba(255, 215, 0, 0.8))
            drop-shadow(0 0 18px rgba(255, 215, 0, 0.6));
}

@keyframes pencilGlow {
    0%, 100% {
        filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.8))
                drop-shadow(0 0 8px rgba(255, 215, 0, 0.6))
                drop-shadow(0 0 12px rgba(255, 215, 0, 0.4));
    }
    50% {
        filter: drop-shadow(0 0 6px rgba(255, 215, 0, 1))
                drop-shadow(0 0 10px rgba(255, 215, 0, 0.7))
                drop-shadow(0 0 14px rgba(255, 215, 0, 0.5));
    }
}

/* Hide pencil when rate limited */
.btn-edit-profile.hidden {
    display: none;
}

/* Responsive adjustments for pencil button */
@media (max-width: 767px) {
    .btn-edit-profile {
        right: -30px;
    }
    
    .btn-edit-profile svg {
        width: 14px;
        height: 14px;
    }
}

@media (max-width: 480px) {
    .btn-edit-profile {
        right: -28px;
    }
    
    .btn-edit-profile svg {
        width: 13px;
        height: 13px;
    }
}

/* Edit Profile Modal Content */
.edit-profile-content {
    padding: 32px 28px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}

.edit-profile-title {
    font-size: 22px;
    font-weight: 700;
    color: #fff;
    margin: 0 0 8px 0;
    text-align: center;
}

/* Avatar Upload Area */
.avatar-upload-container {
    position: relative;
    width: 100px;
    height: 100px;
}

.avatar-upload-preview {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 3px solid #1877f2;
    object-fit: cover;
    cursor: pointer;
    transition: all 0.3s ease;
}

.avatar-upload-preview:hover {
    opacity: 0.8;
    border-color: #2984f6;
}

.avatar-upload-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    cursor: pointer;
    pointer-events: none;
}

.avatar-upload-container:hover .avatar-upload-overlay {
    opacity: 1;
    pointer-events: auto;
}

.avatar-upload-overlay svg {
    stroke: #fff;
}

#avatarInput {
    display: none;
}

/* Display Name Input */
.edit-form-group {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.edit-form-group label {
    font-size: 14px;
    font-weight: 600;
    color: #b0b0b0;
}

.edit-form-group input {
    width: 100%;
    padding: 14px 16px;
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    background: #1a1a1a;
    color: #fff;
    font-size: 16px;
    outline: none;
    transition: all 0.3s ease;
}

.edit-form-group input:focus {
    border-color: #1877f2;
    background: #222;
}

.edit-form-group input::placeholder {
    color: #666;
}

/* Warning Box */
.edit-warning-box {
    background: rgba(251, 191, 36, 0.1);
    border: 1px solid rgba(251, 191, 36, 0.3);
    border-radius: 12px;
    padding: 14px 16px;
    width: 100%;
}

.edit-warning-text {
    font-size: 13px;
    color: #fbbf24;
    line-height: 1.5;
}

/* Buttons */
.edit-profile-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    align-items: center;
}

.btn-save-profile {
    background: linear-gradient(135deg, #1877f2 0%, #0d5fcc 100%);
    color: #fff;
    border: none;
    padding: 16px 24px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    max-width: 400px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
    z-index: 1;
}

.btn-save-profile:hover:not(:disabled) {
    background: linear-gradient(135deg, #2984f6 0%, #1877f2 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(24, 119, 242, 0.4);
}

.btn-save-profile:disabled {
    background: #424242;
    color: #888;
    cursor: not-allowed;
    opacity: 0.6;
}

.btn-cancel-edit {
    background: transparent;
    color: #bbb;
    border: 2px solid rgba(255, 255, 255, 0.2);
    padding: 14px 24px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    max-width: 400px;
    position: relative;
    z-index: 1;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-cancel-edit:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.3);
    color: #fff;
    transform: translateY(-1px);
}

/* Loading State */
.btn-save-profile.loading {
    pointer-events: none;
    opacity: 0.7;
}

.btn-save-profile.loading::after {
    content: '';
    width: 16px;
    height: 16px;
    border: 2px solid #fff;
    border-top-color: transparent;
    border-radius: 50%;
    display: inline-block;
    margin-left: 10px;
    animation: spin 0.6s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Error Message */
.edit-error-message {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 8px;
    padding: 12px;
    color: #ef4444;
    font-size: 13px;
    text-align: center;
    width: 100%;
    display: none;
}

.edit-error-message.show {
    display: block;
}

/* Success Message */
.edit-success-message {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 8px;
    padding: 12px;
    color: #10b981;
    font-size: 13px;
    text-align: center;
    width: 100%;
    display: none;
}

.edit-success-message.show {
    display: block;
}

/* Responsive */
@media (max-width: 480px) {
    .edit-profile-content {
        padding: 24px 20px;
        gap: 16px;
    }

    .edit-profile-title {
        font-size: 19px;
    }

    .avatar-upload-container {
        width: 85px;
        height: 85px;
    }

    .edit-form-group input {
        padding: 12px 14px;
        font-size: 15px;
    }

    .btn-save-profile {
        padding: 14px 20px;
        font-size: 15px;
    }

    .btn-cancel-edit {
        padding: 12px 20px;
        font-size: 14px;
    }
}

/* Google Sign-In Button Styles */
.login-helper-text {
    text-align: center;
    margin-top: 20px;
    font-size: 14px;
    color: var(--text-muted);
}

.login-helper-link {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
}

.login-helper-link:hover {
    text-decoration: underline;
}

.login-divider {
    display: flex;
    align-items: center;
    margin: 24px 0 20px 0;
    color: var(--text-muted);
    font-size: 14px;
}

.login-divider::before,
.login-divider::after {
    content: '';
    flex: 1;
    border-bottom: 1px solid var(--border-color);
}

.login-divider::before {
    margin-right: 12px;
}

.login-divider::after {
    margin-left: 12px;
}

.btn-google-signin {
    width: 100%;
    padding: 12px;
    background: white;
    color: #3c4043;
    border: 1px solid #dadce0;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
}

.btn-google-signin:hover {
    background: #f8f9fa;
    border-color: #c6c6c6;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.btn-google-signin svg {
    width: 20px;
    height: 20px;
}
    </style>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <!-- Skip to main content link -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- HEADER - Using <header> is fine, it's <aside> that causes issues -->
  <header role="banner">
    <div class="header-content">
      <a href="https://www.nuranantoscans.my.id" class="logo-link" aria-label="Nurananto Scanlation Home">
        <img src="assets/logo.png" alt="Nurananto Scanlation Logo" class="site-logo" width="200" height="60">
      </a>

      <nav aria-label="Social media links">
        <!-- Desktop: Show all buttons -->
        <div class="header-buttons">
  <!-- Profile/Login Button -->
  <button class="header-icon-button profile-button" 
          id="btnOpenLogin"
          aria-label="Login or Register">
    <svg class="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
      <circle cx="12" cy="7" r="4"/>
    </svg>
    <span class="button-text">Login</span>
  </button>
  
  <!-- Notification Button -->
  <div class="notification-wrapper">
    <button class="header-icon-button notification-button" 
            id="btnNotification"
            aria-label="View notifications">
      <svg class="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
      </svg>
      <span class="notification-badge" id="notificationBadge" style="display: none;"></span>
    </button>
    
    <!-- Notification Dropdown -->
    <div class="notification-dropdown" id="notificationDropdown" style="display: none;">
      <div class="notification-header">
        <h3>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
          </svg>
          Notifikasi
        </h3>
        <button id="btnSyncNotifications" class="btn-sync-notif" title="Sync komentar / Refresh update">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
          </svg>
        </button>
      </div>
      
      <!-- Notification Tabs -->
      <div class="notification-tabs">
        <button class="notification-tab active" data-tab="comments">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          Komentar
        </button>
        <button class="notification-tab" data-tab="updates">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          Update
        </button>
      </div>
      
      <!-- Comments Content -->
      <div class="notification-content active" id="notificationComments">
        <!-- Comments will be dynamically loaded -->
      </div>
      
      <!-- Updates Content -->
      <div class="notification-content" id="notificationUpdates" style="display: none;">
        <!-- Updates will be dynamically loaded -->
      </div>
    </div>
  </div>
</div>

      <!-- Mobile: Show Login Button Only (No Hamburger) -->
      </nav>
    </div>
    <div class="header-border"></div>
  </header>

  <!-- MAIN content -->
  <main role="main" id="main-content">
    <!-- Main Container - Cover + Info (Desktop Only) -->
    <div class="main-container">
      <!-- Cover Section -->
      <div class="hero-cover">
        <img id="mangaCover" 
             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='450'%3E%3Crect width='300' height='450' fill='%23f5f5f5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23999' font-size='16' font-family='Arial'%3ELoading...%3C/text%3E%3C/svg%3E" 
             alt="Manga Cover" 
             class="manga-cover"
             loading="eager"
             fetchpriority="high">
      </div>

      <!-- Info Section -->
      <div class="hero-info">
        <!-- Status Badge & Last Update -->
        <div class="status-update-container">
          <div id="statusBadgeInfo" class="status-badge-info">ONGOING</div>
          <div class="last-update-info">
            <svg class="clock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            <span id="lastUpdateText">Last Update: -</span>
          </div>
        </div>

        <!-- Title -->
        <h1 id="mainTitle" class="main-title">Loading...</h1>
        <p id="subtitle" class="subtitle"></p>

        <!-- Rating Section (Simple) -->
        <div class="manga-rating-box">
          <span class="label-text">RATING MANGA:</span>
          <span class="rating-value-compact">
            <span id="mangaRatingScore">8.0</span>
            <span class="rating-star-compact">‚òÖ</span>
            <span class="rating-count-compact">(<span id="mangaRatingCount">0</span> rating)</span>
          </span>
        </div>

        <!-- Rating Input (for logged-in users who haven't rated) -->
        <div class="rating-input-compact" id="mangaRatingInput" style="display: none;">
          <p class="rating-instruction-compact">Berikan rating Anda:</p>
          <div class="rating-stars-input-compact">
            <span class="star-input-compact" data-value="1">‚òÜ</span>
            <span class="star-input-compact" data-value="2">‚òÜ</span>
            <span class="star-input-compact" data-value="3">‚òÜ</span>
            <span class="star-input-compact" data-value="4">‚òÜ</span>
            <span class="star-input-compact" data-value="5">‚òÜ</span>
            <span class="star-input-compact" data-value="6">‚òÜ</span>
            <span class="star-input-compact" data-value="7">‚òÜ</span>
            <span class="star-input-compact" data-value="8">‚òÜ</span>
            <span class="star-input-compact" data-value="9">‚òÜ</span>
            <span class="star-input-compact" data-value="10">‚òÜ</span>
          </div>
          <button class="btn-submit-rating-compact" id="btnSubmitMangaRating">Kirim Rating</button>
        </div>

        <!-- Author & Artist -->
        <div class="author-artist-container">
          <div class="author-box">
            <span class="label-text">AUTHOR:</span>
            <span id="authorNameDesktop" class="value-text">-</span>
          </div>
          <div class="artist-box">
            <span class="label-text">ARTIST:</span>
            <span id="artistNameDesktop" class="value-text">-</span>
          </div>
        </div>

        <!-- Action Buttons Container -->
        <div class="action-buttons-container">
          <!-- Read Button -->
          <button class="btn-start-reading" id="btnStartReading">
            <svg class="btn-read-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
            </svg>
            <span class="btn-text-desktop">BACA DARI AWAL</span>
            <span class="btn-text-mobile">BACA</span>
          </button>
          
          <!-- Donation Button -->
          <a href="https://trakteer.id/NuranantoScanlation" 
             target="_blank" 
             rel="noopener noreferrer"
             class="btn-donate"
             aria-label="Donasi untuk membeli chapter (opens in new tab)">
            <svg class="btn-donate-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v12M9 9h6M9 15h6"/>
            </svg>
            <span class="btn-text-desktop">DONASI BELI CHAPTER</span>
            <span class="btn-text-mobile">DONASI</span>
          </a>
        </div>
      </div>
    </div>

    <!-- Information Container with Tabs (Desktop Only) -->
    <div class="information-container">
      <!-- Tab Navigation -->
      <div class="tab-navigation" role="tablist">
        <button class="tab-button active" role="tab" aria-selected="true" aria-controls="about-panel" id="about-tab">
          <span>Tentang Bacaan</span>
        </button>
        <button class="tab-button" role="tab" aria-selected="false" aria-controls="chapters-panel" id="chapters-tab">
          <span>Daftar Chapter</span>
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- About Panel -->
        <div class="tab-panel active" role="tabpanel" id="about-panel" aria-labelledby="about-tab">
          <!-- Chapters Count -->
          <div class="info-stats">
            <div class="stat-item">
              <div class="stat-label">Banyak Chapter</div>
              <div class="stat-value" id="totalChapters">0 Chapters</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Jumlah Pembaca</div>
              <div class="stat-value" id="totalViewer">0</div>
            </div>
          </div>

          <!-- Genre Tags -->
          <div class="info-box-section genre-box-wrapper">
            <div class="genre-box-header">
              <span class="genre-box-label">GENRE</span>
            </div>
            <div id="genreListInfo" class="genre-tags-info" role="list"></div>
          </div>

          <!-- External Links -->
          <div class="external-links-info">
            <button class="info-btn" id="btnMangadexInfo" aria-label="View alternative reading link">
              <img src="assets/mangadex-logo.png" alt="" class="btn-icon" aria-hidden="true">
              <span>Alternatif Link</span>
            </button>
            <button class="info-btn" id="btnRawInfo" aria-label="View source website">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <circle cx="12" cy="12" r="10"/>
                <line x1="2" y1="12" x2="22" y2="12"/>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
              </svg>
              <span>Source Web</span>
            </button>
          </div>

          <!-- Details / Sinopsis -->
          <div class="details-section">
            <h3 class="details-heading">Sinopsis Manga</h3>
            <div class="details-introduction">
              <p id="synopsisInfo" class="synopsis-text"></p>
            </div>
          </div>
        </div>

        <!-- Chapters Panel -->
        <div class="tab-panel" role="tabpanel" id="chapters-panel" aria-labelledby="chapters-tab">
          <div id="chapterListInfo" class="chapter-list-info" role="list"></div>
        </div>
      </div>
    </div>

    <!-- Comment Container -->
    <div class="comment-container">
      <div class="comment-header-section">
        <h2 class="comment-heading">Komentar</h2>
        
        <!-- Login Button (shown when not logged in) -->
        <button class="btn-login-comment" id="btnLoginComment">
          <svg class="login-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          Login untuk Berkomentar
        </button>
      </div>

      <!-- Comment Input Section (for logged-in users) -->
      <div class="comment-input-section" id="commentInputSection" style="display: none;">
        <div class="comment-input-wrapper">
          <img class="comment-avatar" id="commentInputAvatar" src="assets/Logo 2.png" alt="Avatar" />
          <div class="comment-input-content">
            <textarea 
              class="comment-textarea" 
              id="commentTextarea" 
              placeholder="Tulis komentar Anda... (max 500 karakter)"
              maxlength="500"></textarea>
            <div class="comment-input-footer">
              <span class="comment-char-count">
                <span id="commentCharCount">0</span>/500
              </span>
              <button class="btn-submit-comment" id="btnSubmitComment">Kirim Komentar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Comments List -->
      <div class="comments-list" id="commentsList">
        <div class="comment-placeholder">
          <p>Belum ada komentar. Jadilah yang pertama!</p>
        </div>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer role="contentinfo" class="main-footer">
    <div class="footer-content">
      <div class="footer-disclaimer">
        <h3 class="footer-title">Disclaimer</h3>
        <p class="footer-text">
          Semua bacaan yang ada di website ini merupakan hasil terjemahan fans <strong>Nurananto Scanlation</strong> bukan terjemahan resmi. 
          Jangan lupa untuk memberikan dukungan langsung kepada author dengan membeli karya-karya asli mereka melalui link raw yang sudah disediakan.
        </p>
        <h3 class="footer-title">Support Author</h3>
        <p class="footer-text">
          Beli karya asli untuk mendukung author dan industri manga/komik yang Anda sukai!
        </p>
      </div>
    </div>
  </footer>

  <script defer src="common.js?v=2.2.2"></script>
  <script defer src="auto-reload.js?v=2.2.2"></script>
  <script defer src="manga-config.js?v=2.2.2"></script>
  <script defer src="info-manga.js?v=3.2.9"></script>
  
<script>
/**
 * ‚úÖ Enhanced Service Worker Registration
 * - Aggressive cache clearing on update
 * - Better error handling
 * - No query string in SW URL
 */
if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
        try {
            // ‚úÖ STEP 1: Unregister old SW with query string
            // Silent operation - no console logs
            const regs = await navigator.serviceWorker.getRegistrations();
            
            for (const reg of regs) {
                // If SW has query string in URL, unregister it
                if (reg.active && reg.active.scriptURL.includes('?v=')) {
                    await reg.unregister();
                    
                    // ‚úÖ Clear all caches after unregistering
                    if ('caches' in window) {
                        const cacheNames = await caches.keys();
                        await Promise.all(cacheNames.map(name => caches.delete(name)));
                    }
                }
            }
            
            // ‚úÖ STEP 2: Register new SW (NO query string)
            const registration = await navigator.serviceWorker.register('./sw.js', {
                updateViaCache: 'none',
                scope: './'
            });
            
            // ‚úÖ STEP 3: Check for updates immediately
            registration.update();
            
            // ‚úÖ STEP 4: Listen for updates
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        
                        // Optional: Show update notification
                        // You can uncomment this to notify users
                        /*
                        if (confirm('New version available! Reload now?')) {
                            window.location.reload();
                        }
                        */
                    }
                });
            });
            
            // ‚úÖ STEP 5: Handle controller change
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    // console.log('üîÑ SW controller changed, reloading...');
                    window.location.reload();
                }
            });
            
        } catch (err) {
            // Silent error handling - only show critical errors
            console.error('‚ùå SW registration failed:', err);
        }
    });
}
</script>
<!-- ‚úÖ Login Modal -->
<div id="loginModal" class="modal-overlay" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="login-modal-title">
  <div class="login-modal-content">
    <!-- ‚úÖ Disclaimer Banner -->
    <div style="background: linear-gradient(135deg, #1877f2 0%, #166fe5 100%); padding: 12px; border-radius: 8px 8px 0 0; text-align: center;">
      <div style="color: white; font-size: 13px; font-weight: 600;">
        üîí Secure Login - Nurananto Scanlation Web
      </div>
    </div>

    <!-- Tabs -->
    <div class="login-tabs" role="tablist">
      <button class="login-tab active" id="tabLogin" role="tab" aria-selected="true" aria-controls="panelLogin">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3"/>
        </svg>
        Login
      </button>
      <button class="login-tab" id="tabRegister" role="tab" aria-selected="false" aria-controls="panelRegister">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="8.5" cy="7" r="4"/>
          <line x1="20" y1="8" x2="20" y2="14"/>
          <line x1="23" y1="11" x2="17" y2="11"/>
        </svg>
        Register
      </button>
      <button class="login-tab" id="tabForgot" role="tab" aria-selected="false" aria-controls="panelForgot">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
        </svg>
        Forgot
      </button>
    </div>

    <!-- Login Panel -->
    <div class="login-panel active" id="panelLogin" role="tabpanel" aria-labelledby="tabLogin">
      <h2 id="login-modal-title" class="login-title">Selamat Datang</h2>
      <form class="login-form" autocomplete="on" action="javascript:void(0)">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" 
                 id="loginEmail" 
                 name="email"
                 placeholder="you@example.com" 
                 autocomplete="email" 
                 required>
        </div>
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <div class="password-input-wrapper">
            <input type="password" 
                   id="loginPassword" 
                   name="password"
                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                   autocomplete="current-password" 
                   required>
            <button type="button" class="toggle-password" aria-label="Toggle password visibility">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
          </div>
        </div>
        <button type="submit" class="btn-login">Login</button>
        <div class="form-message" id="loginMessage" style="display: none;"></div>
      </form>
      
      <div class="login-divider">Atau lanjutkan dengan</div>
      
      <button type="button" class="btn-google-signin" id="googleSignInLogin">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
        </svg>
        Login dengan Google
      </button>
      
      <div class="login-helper-text">
        Belum punya akun? <a class="login-helper-link" id="linkToRegister">Daftar Sekarang</a>
      </div>
    </div>

    <!-- Register Panel -->
    <div class="login-panel" id="panelRegister" role="tabpanel" aria-labelledby="tabRegister">
      <h2 class="login-title">Buat Akun Baru</h2>
      <form class="login-form" autocomplete="on" action="javascript:void(0)">
        <div class="form-group">
          <label for="registerEmail">Email</label>
          <input type="email" 
                 id="registerEmail" 
                 name="email"
                 placeholder="you@example.com" 
                 autocomplete="email" 
                 required>
        </div>
        <div class="form-group">
          <label for="registerPassword">Password</label>
          <div class="password-input-wrapper">
            <input type="password" 
                   id="registerPassword" 
                   name="new-password"
                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                   autocomplete="new-password" 
                   required>
            <button type="button" class="toggle-password" aria-label="Toggle password visibility">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
          </div>
          <div class="password-strength" id="passwordStrength" style="display: none;">
            <div class="strength-bar">
              <div class="strength-fill" id="strengthFill"></div>
            </div>
            <span class="strength-text" id="strengthText"></span>
            <ul class="strength-hints" id="strengthHints"></ul>
          </div>
        </div>
        <div class="form-group">
          <label for="registerConfirm">Confirm Password</label>
          <div class="password-input-wrapper">
            <input type="password" 
                   id="registerConfirm" 
                   name="confirm-password"
                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                   autocomplete="new-password" 
                   required>
            <button type="button" class="toggle-password" aria-label="Toggle password visibility">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
          </div>
          <div class="password-match" id="passwordMatch" style="display: none;"></div>
        </div>
        <button type="submit" class="btn-login">Register</button>
        <div class="form-message" id="registerMessage" style="display: none;"></div>
      </form>
      
      <div class="login-divider">Atau lanjutkan dengan</div>
      
      <button type="button" class="btn-google-signin" id="googleSignInRegister">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
        </svg>
        Daftar dengan Google
      </button>
      
      <div class="login-helper-text">
        Sudah punya akun? <a class="login-helper-link" id="linkToLogin">Login Sekarang</a>
      </div>
    </div>

    <!-- Forgot Password Panel -->
    <div class="login-panel" id="panelForgot" role="tabpanel" aria-labelledby="tabForgot">
      <h2 class="login-title">Ubah Password</h2>
      <p class="login-subtitle">Masukkan email untuk menerima link reset</p>
      <form class="login-form" id="formForgotPassword" autocomplete="on" action="javascript:void(0)">
        <div class="form-group">
          <label for="forgotEmail">Email</label>
          <input type="email" 
                 id="forgotEmail" 
                 name="email"
                 placeholder="you@example.com" 
                 autocomplete="email" 
                 required>
        </div>
        <p id="forgotError" class="code-error"></p>
        <button type="submit" class="btn-login" id="btnSendReset">Kirim Link Reset</button>
        <div class="form-message" id="forgotMessage" style="display: none;"></div>
      </form>
    </div>
  </div>
</div>

<!-- ‚úÖ Profile Modal (TERPISAH - DI LUAR loginModal) -->
<div id="profileModal" class="modal-overlay" style="display: none;" role="dialog" aria-modal="true">
  <div class="login-modal-content">
    <div class="profile-content">
      <!-- Avatar -->
      <img src="assets/Logo 2.png" alt="Profile Avatar" class="profile-avatar">
      
      <!-- Username with Edit Button -->
      <div class="profile-username-container">
        <h2 id="profileUsername" class="profile-username">Username</h2>
        <button id="btnEditProfile" class="btn-edit-profile" aria-label="Edit Profile">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
        </button>
      </div>
      
      <!-- Status Badge -->
      <div id="statusBadge" class="status-box pembaca-setia">
        <span id="statusText">PEMBACA SETIA</span>
      </div>
      
      <!-- Countdown Timer (only for donatur setia) -->
      <!-- Text akan diupdate oleh JavaScript berdasarkan expiresAt dari API -->
      <div id="countdownBox" class="countdown-box" style="display: none;">
        <span id="countdownText"></span>
      </div>
      
      <!-- Upgrade Button (show for non-donatur) -->
      <button id="btnUpgrade" class="btn-upgrade-profile">
        ‚ö° UPGRADE
      </button>
      
      <!-- ‚úÖ History Button -->
      <button id="btnHistory" class="btn-history">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        HISTORY BACA
      </button>
      
      <!-- Logout Button -->
      <button id="btnLogout" class="btn-logout-profile">LOGOUT</button>
    </div>
  </div>
</div>

<!-- ‚úÖ Edit Profile Modal -->
<div id="editProfileModal" class="modal-overlay" style="display: none;" role="dialog" aria-modal="true">
  <div class="login-modal-content">
    <div class="edit-profile-content">
      <h2 class="edit-profile-title">Edit Profile</h2>

      <!-- Avatar Upload -->
      <div class="avatar-upload-container">
        <img id="avatarPreview" src="assets/Logo 2.png" alt="Avatar Preview" class="avatar-upload-preview">
        <div class="avatar-upload-overlay" id="avatarUploadOverlay">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
        </div>
        <input type="file" id="avatarInput" accept="image/jpeg,image/png,image/webp">
      </div>

      <!-- Display Name Input -->
      <div class="edit-form-group">
        <label for="displayNameInput">Nama Tampilan</label>
        <input 
          type="text" 
          id="displayNameInput" 
          placeholder="Masukkan nama (3-30 karakter)"
          minlength="3"
          maxlength="30"
        >
      </div>

      <!-- Warning -->
      <div class="edit-warning-box">
        <span class="edit-warning-text">
          ‚ö†Ô∏è Ganti foto profile dan nama profile hanya bisa dilakukan <strong>sekali dalam sebulan</strong>.
        </span>
      </div>

      <!-- Error Message -->
      <div id="editErrorMessage" class="edit-error-message"></div>

      <!-- Success Message -->
      <div id="editSuccessMessage" class="edit-success-message"></div>

      <!-- Buttons -->
      <div class="edit-profile-buttons">
        <button id="btnSaveProfile" class="btn-save-profile" disabled>
          SIMPAN
        </button>
        <button id="btnCancelEdit" class="btn-cancel-edit">
          BATAL
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Login Required Modal (untuk user yang belum login) -->
<div id="loginRequiredModal" class="modal-overlay" style="display: none;">
  <div class="login-modal-content">
    <div class="login-required-content">
      <h2 class="login-required-title">üîí Chapter Terkunci üîí</h2>
      <p class="login-required-message login-required-message-primary">
        Chapter Terkunci karena <span class="highlight-text">RAW berbayar</span>.
      </p>
      <p class="login-required-message login-required-message-secondary">
        Locked Chapter bisa dibaca dengan cara
      </p>
      
      <div class="login-required-buttons">
        <button id="btnLoginFromRequired" class="login-required-btn login-required-btn-primary">
          üîê Login dan Jadilah DONATUR SETIA
        </button>
        <a id="btnTrakteerPost" href="https://trakteer.id/NuranantoScanlation/posts" target="_blank" class="login-required-btn login-required-btn-trakteer">
          üìñ Baca di Post Trakteer
        </a>
      </div>
      
      <button id="btnCloseLoginRequired" class="btn-close-modal">BATAL</button>
    </div>
  </div>
</div>

<div id="upgradeModal" class="modal-overlay" style="display: none;">
  <div class="login-modal-content">
    <div class="upgrade-content">
      <h2 class="upgrade-title">‚≠ê UPGRADE KE DONATUR SETIA ‚≠ê</h2>
<div class="benefits-list">
  <div class="benefit-item">‚úÖ Akses semua chapter terkunci (locked)</div>
  <div class="benefit-item">‚úÖ Badge DONATUR SETIA di akun Anda</div>
</div>
      
      <div class="upgrade-buttons">
        <button id="btnPanduan" class="upgrade-btn upgrade-btn-panduan">
          üìñ PANDUAN WAJIB BACA!
        </button>
        <button id="btnDonasi" class="upgrade-btn upgrade-btn-trakteer">
          Donasi via Trakteer
          <span class="badge-instant">INSTANT</span>
        </button>
        <button id="btnVIPCode" class="upgrade-btn upgrade-btn-code">
          Punya DONATUR CODE?
        </button>
      </div>
      
      <button id="btnCloseUpgrade" class="btn-close-modal">BATAL</button>
    </div>
  </div>
</div>

<!-- Panduan Modal -->
<div id="panduanModal" class="modal-overlay" style="display: none;">
  <div class="login-modal-content">
    <div class="panduan-content">
      <h2 class="panduan-title">‚ö†Ô∏è BACA DULU ‚ö†Ô∏è<br>Sebelum Donasi atau Input Code</h2>
      
      <div class="panduan-section">
        <h3 class="panduan-section-title">Donatur Code</h3>
        <ul class="panduan-list">
          <li>Input CODE ‚Üí Redeem</li>
          <li>Status langsung DONATUR SETIA</li>
          <li>Chapter terkunci langsung terbuka di website</li>
        </ul>
        <p class="panduan-warning">‚ö†Ô∏è CODE TIDAK SELALU ADA<br>Dibagikan di waktu tertentu saja</p>
      </div>

      <div class="panduan-section">
        <h3 class="panduan-section-title">Donasi Lewat Trakteer</h3>
        <p class="panduan-warning-red">(WAJIB DIPAHAMI)</p>
        
        <ul class="panduan-list">
          <li>Tuliskan email login pada Pesan Dukungan.</li>
          <li>Pastikan penulisan email benar dan tidak ada typo tulisan apapun.</li>
          <li>JANGAN CENTANG "jadikan pesan private".</li>
        </ul>
        
        <img src="https://raw.githubusercontent.com/nurananto/nuranantoscans/refs/heads/main/assets/Login.webp" alt="Contoh Donasi Trakteer" style="width: 100%; max-width: 500px; margin: 16px auto; display: block; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.2);">
      </div>

      <button id="btnBackToUpgrade" class="upgrade-btn upgrade-btn-primary" style="width: 100%; margin-top: 8px;">
        ‚Üê Kembali ke Upgrade
      </button>
    </div>
  </div>
</div>

<!-- VIP Code Modal -->
<div id="codeModal" class="modal-overlay" style="display: none;">
  <div class="login-modal-content">
    <div class="code-content">
      <h2 class="code-title">Masukkan Donatur Code</h2>
      <form id="formVIPCode">
        <input type="text" id="inputVIPCode" placeholder="Masukkan kode Donatur Anda" required readonly>
        <p id="codeError" class="code-error"></p>
        <div class="code-buttons">
          <!-- ‚úÖ Tombol PASTE (tampil dulu) -->
          <button type="button" id="btnPasteCode" class="btn-primary">
            üìã PASTE CODE
          </button>
          <!-- ‚úÖ Tombol REDEEM (hidden dulu, muncul setelah paste) -->
          <button type="submit" id="btnRedeemCode" class="btn-primary" style="display: none;">
            ‚ö° REDEEM CODE
          </button>
          <button type="button" id="btnBackFromCode" class="btn-secondary">BATAL</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- History Modal -->
<div id="historyModal" class="modal-overlay" style="display: none;" role="dialog" aria-modal="true">
  <div class="login-modal-content">
    <div class="history-content">
      <h2 class="history-title">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        History Baca
      </h2>
      
      <!-- Loading State -->
      <div id="historyLoading" class="history-loading">
        <div class="spinner" aria-hidden="true"></div>
        <p>Memuat history...</p>
      </div>
      
      <!-- History List -->
      <div id="historyList" class="history-list" style="display: none;"></div>
      
      <!-- Empty State -->
      <div id="historyEmpty" class="history-empty" style="display: none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
          <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
        </svg>
        <p>Belum ada history</p>
        <small>Mulai baca manga untuk melihat history</small>
      </div>
      
      <button id="btnCloseHistory" class="btn-close-history">TUTUP</button>
    </div>
  </div>
</div>

<!-- Browser Image Compression Library - Load with error handling -->
<script>
(function() {
    // console.log('üì¶ [CDN-LOADER] Starting to load browser-image-compression...');
    
    // Use jsDelivr as primary CDN (most reliable, no SRI issues)
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js';
    script.async = false; // Synchronous loading
    script.crossOrigin = 'anonymous';
    
    script.onload = function() {
        // console.log('‚úÖ [CDN-LOADER] browser-image-compression loaded successfully from jsDelivr!');
        // console.log('   - typeof imageCompression:', typeof imageCompression);
        // console.log('   - window.imageCompression:', !!window.imageCompression);
    };
    
    script.onerror = function() {
        console.error('‚ùå [CDN-LOADER] Failed to load from jsDelivr, trying unpkg fallback...');
        
        // Try fallback CDN #1: unpkg
        const fallbackScript1 = document.createElement('script');
        fallbackScript1.src = 'https://unpkg.com/browser-image-compression@2.0.2/dist/browser-image-compression.js';
        fallbackScript1.async = false;
        
        fallbackScript1.onload = function() {
            // console.log('‚úÖ [CDN-LOADER] browser-image-compression loaded from unpkg fallback!');
            // console.log('   - typeof imageCompression:', typeof imageCompression);
        };
        
        fallbackScript1.onerror = function() {
            console.error('‚ùå [CDN-LOADER] unpkg failed, trying cdnjs fallback...');
            
            // Try fallback CDN #2: cdnjs (last resort, no SRI check)
            const fallbackScript2 = document.createElement('script');
            fallbackScript2.src = 'https://cdnjs.cloudflare.com/ajax/libs/browser-image-compression/2.0.2/browser-image-compression.min.js';
            fallbackScript2.async = false;
            
            fallbackScript2.onload = function() {
                // console.log('‚úÖ [CDN-LOADER] browser-image-compression loaded from cdnjs fallback!');
                // console.log('   - typeof imageCompression:', typeof imageCompression);
            };
            
            fallbackScript2.onerror = function() {
                console.error('‚ùå [CDN-LOADER] All 3 CDN sources failed!');
                console.error('‚ùå [CDN-LOADER] Avatar compression will not work.');
                console.error('üí° [CDN-LOADER] Please check your internet connection or try disabling ad blocker.');
            };
            
            document.head.appendChild(fallbackScript2);
        };
        
        document.head.appendChild(fallbackScript1);
    };
    
    document.head.appendChild(script);
    // console.log('üîÑ [CDN-LOADER] Script tag added to head, waiting for load...');
})();
</script>

<!-- Edit Profile Handler -->
<script>
// Edit Profile functionality - Global initialization function
// This is called every time profile modal is cloned/opened
window.initEditProfile = function() {
    // Debug flag - set to true to enable console logging
    const DEBUG = false;
    
    // console.log('üé® [EDIT-PROFILE] ========================================');
    // console.log('üé® [EDIT-PROFILE] Initializing edit profile module...');
    
    const editProfileModal = document.getElementById('editProfileModal');
    const profileModal = document.getElementById('profileModal');
    const btnEditProfile = document.getElementById('btnEditProfile');
    const btnCancelEdit = document.getElementById('btnCancelEdit');
    const btnSaveProfile = document.getElementById('btnSaveProfile');
    const avatarInput = document.getElementById('avatarInput');
    const avatarPreview = document.getElementById('avatarPreview');
    const avatarUploadOverlay = document.getElementById('avatarUploadOverlay');
    const displayNameInput = document.getElementById('displayNameInput');
    const editErrorMessage = document.getElementById('editErrorMessage');
    const editSuccessMessage = document.getElementById('editSuccessMessage');

    // console.log('üîç [EDIT-PROFILE] DOM Elements check:');
    // console.log('   - editProfileModal:', !!editProfileModal);
    // console.log('   - profileModal:', !!profileModal);
    // console.log('   - btnEditProfile:', !!btnEditProfile);
    // console.log('   - btnCancelEdit:', !!btnCancelEdit);
    // console.log('   - btnSaveProfile:', !!btnSaveProfile);
    // console.log('   - avatarInput:', !!avatarInput);
    // console.log('   - avatarPreview:', !!avatarPreview);
    // console.log('   - avatarUploadOverlay:', !!avatarUploadOverlay);
    // console.log('   - displayNameInput:', !!displayNameInput);
    // console.log('   - editErrorMessage:', !!editErrorMessage);
    // console.log('   - editSuccessMessage:', !!editSuccessMessage);

    let selectedAvatarFile = null;
    let hasChanges = false;
    const PROFILE_WORKER_URL = 'https://profile-worker.nuranantoadhien.workers.dev';
    
    // console.log('‚öôÔ∏è [EDIT-PROFILE] Worker URL:', PROFILE_WORKER_URL);
    // console.log('üé® [EDIT-PROFILE] ========================================');

    // Open edit profile modal
    if (btnEditProfile) {
        btnEditProfile.addEventListener('click', function() {
            // console.log('‚úèÔ∏è [EDIT] ========================================');
            // console.log('‚úèÔ∏è [EDIT] Edit profile button clicked!');
            
            // Load current data
            const currentUsername = document.getElementById('profileUsername')?.textContent || '';
            const currentAvatar = document.querySelector('.profile-avatar')?.src || 'assets/Logo 2.png';
            
            // console.log('üìã [EDIT] Current data:');
            // console.log('   - Username:', currentUsername);
            // console.log('   - Avatar URL:', currentAvatar);
            
            displayNameInput.value = currentUsername;
            avatarPreview.src = currentAvatar;
            
            selectedAvatarFile = null;
            hasChanges = false;
            btnSaveProfile.disabled = true;
            
            // console.log('üîÑ [EDIT] Reset state:');
            // console.log('   - selectedAvatarFile:', selectedAvatarFile);
            // console.log('   - hasChanges:', hasChanges);
            // console.log('   - btnSaveProfile.disabled:', btnSaveProfile.disabled);
            
            // Hide messages
            editErrorMessage.classList.remove('show');
            editSuccessMessage.classList.remove('show');
            
            profileModal.style.display = 'none';
            editProfileModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // console.log('‚úÖ [EDIT] Edit profile modal opened!');
            // console.log('‚úèÔ∏è [EDIT] ========================================');
        });
        // console.log('‚úÖ [EDIT-PROFILE] Edit button listener added');
    }

    // Close edit modal
    if (btnCancelEdit) {
        btnCancelEdit.addEventListener('click', function() {
            // console.log('‚ùå [CANCEL] ========================================');
            // console.log('‚ùå [CANCEL] Cancel button clicked!');
            
            // üÜï Check if this is from Google registration
            if (window.isFromGoogleRegistration) {
                console.log('üö™ [CANCEL] New user canceling edit - showing Profile Modal with defaults...');
                
                // Clear flag
                window.isFromGoogleRegistration = false;
                
                // Get user data from localStorage
                const userStr = localStorage.getItem('user');
                const user = userStr ? JSON.parse(userStr) : null;
                
                // Close edit modal
                editProfileModal.style.display = 'none';
                
                // Check donatur status first, then show profile modal with defaults
                if (typeof checkDonaturStatus === 'function' && typeof showProfileModal === 'function') {
                    checkDonaturStatus().then(() => {
                        console.log('‚úÖ [CANCEL] Status refreshed, showing profile modal...');
                        setTimeout(() => {
                            showProfileModal(user);
                            console.log('‚úÖ [CANCEL] Profile modal shown with default name and avatar');
                        }, 300);
                    }).catch(err => {
                        console.log('‚ö†Ô∏è [CANCEL] Status check error, showing profile anyway:', err);
                        setTimeout(() => {
                            showProfileModal(user);
                        }, 300);
                    });
                } else {
                    console.log('‚ö†Ô∏è [CANCEL] Functions not available, showing profile modal directly');
                    profileModal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            } else {
                // Normal cancel - just close edit and show profile
                // console.log('‚ùå [CANCEL] Closing edit modal...');
                editProfileModal.style.display = 'none';
                profileModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // ‚úÖ Dispatch event untuk notify system bahwa modal ditutup
                window.dispatchEvent(new Event('profileModalClosed'));
                
                // console.log('‚úÖ [CANCEL] Edit modal closed, profile modal shown');
            }
            
            // console.log('‚ùå [CANCEL] ========================================');
        });
        // console.log('‚úÖ [EDIT-PROFILE] Cancel button listener added');
    }

    // Avatar upload handler
    if (avatarUploadOverlay && avatarPreview && avatarInput) {
        if (DEBUG) console.log('üîß [AVATAR-SETUP] Setting up avatar upload handlers...');
        if (DEBUG) console.log('   - avatarUploadOverlay:', !!avatarUploadOverlay);
        if (DEBUG) console.log('   - avatarPreview:', !!avatarPreview);
        if (DEBUG) console.log('   - avatarInput:', !!avatarInput);
        if (DEBUG) console.log('   - avatarInput.type:', avatarInput.type);
        if (DEBUG) console.log('   - avatarInput.id:', avatarInput.id);
        
        avatarUploadOverlay.addEventListener('click', function() {
            if (DEBUG) console.log('üñºÔ∏è [AVATAR] Avatar overlay clicked - opening file picker...');
            avatarInput.click();
        });

        avatarPreview.addEventListener('click', function() {
            if (DEBUG) console.log('üñºÔ∏è [AVATAR] Avatar preview clicked - opening file picker...');
            avatarInput.click();
        });

        avatarInput.addEventListener('change', async function(e) {
            if (DEBUG) console.log('üìÅ [AVATAR] ========================================');
            if (DEBUG) console.log('üìÅ [AVATAR] *** FILE INPUT CHANGE EVENT FIRED! ***');
            if (DEBUG) console.log('üìÅ [AVATAR] Event:', e);
            if (DEBUG) console.log('üìÅ [AVATAR] e.target:', e.target);
            if (DEBUG) console.log('üìÅ [AVATAR] e.target.files:', e.target.files);
            if (DEBUG) console.log('üìÅ [AVATAR] e.target.files.length:', e.target.files?.length);
            
            const file = e.target.files[0];
            if (DEBUG) console.log('üìÅ [AVATAR] file:', file);
            
            if (!file) {
                if (DEBUG) console.log('‚ö†Ô∏è [AVATAR] No file selected');
                if (DEBUG) console.log('üìÅ [AVATAR] ========================================');
                return;
            }

            if (DEBUG) console.log('üìÇ [AVATAR] File selected:');
            if (DEBUG) console.log('   - Name:', file.name);
            if (DEBUG) console.log('   - Type:', file.type);
            if (DEBUG) console.log('   - Size:', (file.size / 1024).toFixed(2), 'KB');

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                console.error('‚ùå [AVATAR] Invalid file type:', file.type);
                showError('Format file harus JPEG, PNG, atau WebP');
                if (DEBUG) console.log('üìÅ [AVATAR] ========================================');
                return;
            }
            
            if (DEBUG) console.log('‚úÖ [AVATAR] File type valid');

            try {
                if (DEBUG) console.log('üîÑ [AVATAR] Starting compression...');
                
                // Check if imageCompression library is loaded
                if (typeof imageCompression === 'undefined') {
                    console.error('‚ùå [AVATAR] imageCompression library not loaded!');
                    showError('Library kompresi gambar belum siap. Silakan refresh halaman dan coba lagi.');
                    if (DEBUG) console.log('üìÅ [AVATAR] ========================================');
                    return;
                }
                
                if (DEBUG) console.log('‚úÖ [AVATAR] imageCompression library available');
                
                // Compress image (disable web worker to avoid CSP issues)
                const options = {
                    maxSizeMB: 0.5, // Target 500KB (more realistic)
                    maxWidthOrHeight: 1024, // Allow slightly larger for better quality
                    useWebWorker: false, // Disable to avoid CSP blob: restriction
                    fileType: file.type,
                    initialQuality: 0.8 // Start with 80% quality
                };

                const compressedFile = await imageCompression(file, options);
                
                if (DEBUG) console.log('‚úÖ [AVATAR] Compression complete:');
                if (DEBUG) console.log('   - Original size:', (file.size / 1024).toFixed(2), 'KB');
                if (DEBUG) console.log('   - Compressed size:', (compressedFile.size / 1024).toFixed(2), 'KB');
                if (DEBUG) console.log('   - Reduction:', ((1 - compressedFile.size / file.size) * 100).toFixed(1), '%');
                
                // Smart file selection: use original if compression made it bigger
                let finalFile;
                if (compressedFile.size >= file.size) {
                    if (DEBUG) console.log('‚ö†Ô∏è [AVATAR] Compressed file is larger than original, using original instead');
                    finalFile = file;
                } else {
                    if (DEBUG) console.log('‚úÖ [AVATAR] Using compressed file (smaller)');
                    finalFile = compressedFile;
                }
                
                if (DEBUG) console.log('üìä [AVATAR] Final file stats:');
                if (DEBUG) console.log('   - Final size:', (finalFile.size / 1024).toFixed(2), 'KB');
                
                // Check final size
                if (finalFile.size > 1024 * 1024) {
                    console.error('‚ùå [AVATAR] File too large:', (finalFile.size / 1024).toFixed(2), 'KB');
                    showError('Ukuran file maksimal 1 MB');
                    if (DEBUG) console.log('üìÅ [AVATAR] ========================================');
                    return;
                }

                selectedAvatarFile = finalFile;
                if (DEBUG) console.log('üíæ [AVATAR] File stored in memory');
                
                // Preview
                if (DEBUG) console.log('üñºÔ∏è [AVATAR] Updating preview...');
                if (DEBUG) console.log('   - avatarPreview element:', avatarPreview);
                if (DEBUG) console.log('   - avatarPreview.src (before):', avatarPreview.src);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (DEBUG) console.log('üì∏ [AVATAR] FileReader onload fired');
                    if (DEBUG) console.log('   - Result length:', e.target.result.length);
                    avatarPreview.src = e.target.result;
                    if (DEBUG) console.log('   - avatarPreview.src (after):', avatarPreview.src.substring(0, 50) + '...');
                    if (DEBUG) console.log('‚úÖ [AVATAR] Preview updated successfully!');
                };
                reader.onerror = function(e) {
                    console.error('‚ùå [AVATAR] FileReader error:', e);
                };
                reader.readAsDataURL(finalFile);
                if (DEBUG) console.log('üîÑ [AVATAR] FileReader started reading...');

                hasChanges = true;
                checkChanges();
                
                if (DEBUG) console.log('‚úÖ [AVATAR] Avatar upload complete!');
                if (DEBUG) console.log('   - hasChanges:', hasChanges);
                if (DEBUG) console.log('üìÅ [AVATAR] ========================================');
            } catch (error) {
                console.error('‚ùå [AVATAR] Compression error:', error);
                showError('Gagal memproses gambar');
                // console.log('üìÅ [AVATAR] ========================================');
            }
        });
        // console.log('‚úÖ [EDIT-PROFILE] Avatar upload listeners added');
    }

    // Display name change handler
    if (displayNameInput) {
        displayNameInput.addEventListener('input', function() {
            // console.log('‚å®Ô∏è [NAME] Display name input changed:', this.value);
            
            const currentUsername = document.getElementById('profileUsername')?.textContent || '';
            hasChanges = this.value.trim() !== currentUsername || selectedAvatarFile !== null;
            
            // console.log('üîÑ [NAME] hasChanges:', hasChanges);
            // console.log('   - Current:', currentUsername);
            // console.log('   - New:', this.value.trim());
            // console.log('   - Has avatar:', selectedAvatarFile !== null);
            
            checkChanges();
        });
        // console.log('‚úÖ [EDIT-PROFILE] Display name input listener added');
    }

    // Check if there are changes
    function checkChanges() {
        const isValid = displayNameInput.value.trim().length >= 3 && 
                       displayNameInput.value.trim().length <= 30;
        const wasDisabled = btnSaveProfile.disabled;
        btnSaveProfile.disabled = !hasChanges || !isValid;
        
        if (wasDisabled !== btnSaveProfile.disabled) {
            if (DEBUG) console.log('üîò [CHECK] Save button state changed:');
            if (DEBUG) console.log('   - Disabled:', btnSaveProfile.disabled);
            if (DEBUG) console.log('   - hasChanges:', hasChanges);
            if (DEBUG) console.log('   - isValid:', isValid);
            if (DEBUG) console.log('   - Name length:', displayNameInput.value.trim().length);
        }
    }

    // Show error message
    function showError(message) {
        if (DEBUG) console.error('‚ùå [ERROR] Showing error:', message);
        editErrorMessage.textContent = message;
        editErrorMessage.classList.add('show');
        editSuccessMessage.classList.remove('show');
        setTimeout(() => {
            editErrorMessage.classList.remove('show');
            if (DEBUG) console.log('üîÑ [ERROR] Error message auto-hidden');
        }, 5000);
    }

    // Show success message
    function showSuccess(message) {
        if (DEBUG) console.log('‚úÖ [SUCCESS] Showing success:', message);
        editSuccessMessage.textContent = message;
        editSuccessMessage.classList.add('show');
        editErrorMessage.classList.remove('show');
    }

    // Save profile
    if (btnSaveProfile) {
        btnSaveProfile.addEventListener('click', async function() {
            if (DEBUG) console.log('üíæ [SAVE] ========================================');
            if (DEBUG) console.log('üíæ [SAVE] Save profile button clicked!');
            
            if (this.disabled || this.classList.contains('loading')) {
                if (DEBUG) console.log('‚ö†Ô∏è [SAVE] Button disabled or loading - ignoring click');
                if (DEBUG) console.log('üíæ [SAVE] ========================================');
                return;
            }

            this.classList.add('loading');
            this.textContent = 'MENYIMPAN';
            editErrorMessage.classList.remove('show');
            editSuccessMessage.classList.remove('show');
            
            if (DEBUG) console.log('üîÑ [SAVE] Button set to loading state');

            // Use getAuthToken() from common.js (checks expiry too)
            const token = getAuthToken();
            if (!token) {
                console.error('‚ùå [SAVE] No token found!');
                showError('Anda harus login terlebih dahulu');
                this.classList.remove('loading');
                this.textContent = 'SIMPAN';
                if (DEBUG) console.log('üíæ [SAVE] ========================================');
                return;
            }
            
            if (DEBUG) console.log('‚úÖ [SAVE] Token found:', token.substring(0, 20) + '...');

            try {
                let success = false;

                // Upload avatar if changed
                if (selectedAvatarFile) {
                    if (DEBUG) console.log('üì§ [SAVE] Uploading avatar...');
                    if (DEBUG) console.log('   - File size:', (selectedAvatarFile.size / 1024).toFixed(2), 'KB');
                    if (DEBUG) console.log('   - File type:', selectedAvatarFile.type);
                    
                    const formData = new FormData();
                    formData.append('avatar', selectedAvatarFile);

                    const avatarResponse = await fetch(`${PROFILE_WORKER_URL}/profile/upload-avatar`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    if (DEBUG) console.log('üì• [SAVE] Avatar upload response status:', avatarResponse.status);
                    const avatarData = await avatarResponse.json();
                    if (DEBUG) console.log('üì¶ [SAVE] Avatar response data:', avatarData);

                    if (avatarData.success) {
                        success = true;
                        if (DEBUG) console.log('‚úÖ [SAVE] Avatar uploaded successfully!');
                        if (DEBUG) console.log('   - New avatar URL:', avatarData.avatarUrl);
                        
                        // Update profile avatar
                        const profileAvatar = document.querySelector('.profile-avatar');
                        if (profileAvatar) {
                            profileAvatar.src = avatarData.avatarUrl;
                            if (DEBUG) console.log('üñºÔ∏è [SAVE] Profile avatar UI updated');
                        }
                    } else {
                        console.error('‚ùå [SAVE] Avatar upload failed:', avatarData.error);
                        throw new Error(avatarData.error || 'Upload avatar gagal');
                    }
                } else {
                    if (DEBUG) console.log('‚è≠Ô∏è [SAVE] No avatar file selected, skipping upload');
                }

                // Update display name if changed
                const currentUsername = document.getElementById('profileUsername')?.textContent || '';
                const newDisplayName = displayNameInput.value.trim();

                if (newDisplayName !== currentUsername) {
                    if (DEBUG) console.log('üìù [SAVE] Updating display name...');
                    if (DEBUG) console.log('   - Old name:', currentUsername);
                    if (DEBUG) console.log('   - New name:', newDisplayName);
                    
                    const nameResponse = await fetch(`${PROFILE_WORKER_URL}/profile/update-name`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ displayName: newDisplayName })
                    });

                    if (DEBUG) console.log('üì• [SAVE] Name update response status:', nameResponse.status);
                    const nameData = await nameResponse.json();
                    if (DEBUG) console.log('üì¶ [SAVE] Name response data:', nameData);

                    if (nameData.success) {
                        success = true;
                        if (DEBUG) console.log('‚úÖ [SAVE] Display name updated successfully!');
                        
                        // Update profile username
                        const profileUsername = document.getElementById('profileUsername');
                        if (profileUsername) {
                            profileUsername.textContent = newDisplayName;
                            if (DEBUG) console.log('üìù [SAVE] Profile username UI updated');
                        }
                    } else {
                        console.error('‚ùå [SAVE] Name update failed:', nameData.error);
                        throw new Error(nameData.error || 'Update nama gagal');
                    }
                } else {
                    if (DEBUG) console.log('‚è≠Ô∏è [SAVE] Display name unchanged, skipping update');
                }

                // Show success
                if (success) {
                    if (DEBUG) console.log('üéâ [SAVE] Profile save complete!');
                    showSuccess('‚úÖ Profile berhasil diupdate!');
                    
                    // Re-check eligibility to hide pencil if rate limited
                    if (typeof window.checkEditEligibility === 'function') {
                        window.checkEditEligibility();
                    }
                    
                    // üîÑ Reload comments to show updated username
                    if (window.infoMangaRatingComments && typeof window.infoMangaRatingComments.loadComments === 'function') {
                        if (DEBUG) console.log('üîÑ [SAVE] Reloading comments to update username...');
                        window.infoMangaRatingComments.loadComments();
                        if (DEBUG) console.log('‚úÖ [SAVE] Comments reload initiated');
                    }

                    // üîÑ Reload comment input avatar to show updated avatar
                    if (window.infoMangaRatingComments && typeof window.infoMangaRatingComments.loadCommentInputAvatar === 'function') {
                        if (DEBUG) console.log('üîÑ [SAVE] Reloading comment input avatar...');
                        // ‚úÖ Call immediately dan juga delayed untuk ensure update
                        window.infoMangaRatingComments.loadCommentInputAvatar();
                        setTimeout(() => {
                            if (DEBUG) console.log('üîÑ [SAVE] Secondary avatar reload (delayed)...');
                            window.infoMangaRatingComments.loadCommentInputAvatar();
                        }, 1000);
                        if (DEBUG) console.log('‚úÖ [SAVE] Comment input avatar reload initiated');
                    }
                    
                    // üÜï Check if this is from Google registration
                    const isFromGoogleReg = window.isFromGoogleRegistration;
                    
                    setTimeout(() => {
                        if (DEBUG) console.log('üîÑ [SAVE] Closing edit modal...');
                        editProfileModal.style.display = 'none';
                        selectedAvatarFile = null;
                        hasChanges = false;
                        
                        // üÜï If from Google registration, refresh status and show profile modal
                        if (isFromGoogleReg) {
                            console.log('üÜï [SAVE] From Google registration - showing Profile Modal...');
                            
                            // Clear flag
                            window.isFromGoogleRegistration = false;
                            
                            // Get user data from localStorage
                            const userStr = localStorage.getItem('user');
                            const user = userStr ? JSON.parse(userStr) : null;
                            
                            // Check donatur status first, then show profile modal
                            if (typeof checkDonaturStatus === 'function' && typeof showProfileModal === 'function') {
                                checkDonaturStatus().then(() => {
                                    console.log('‚úÖ [SAVE] Status refreshed, showing profile modal...');
                                    setTimeout(() => showProfileModal(user), 300);
                                }).catch(err => {
                                    console.log('‚ö†Ô∏è [SAVE] Status check error, showing profile anyway:', err);
                                    setTimeout(() => showProfileModal(user), 300);
                                });
                            } else {
                                console.log('‚ö†Ô∏è [SAVE] Functions not available, showing profile modal directly');
                                profileModal.style.display = 'flex';
                                document.body.style.overflow = 'hidden';
                            }
                        } else {
                            // Normal edit - just show profile modal
                            profileModal.style.display = 'flex';
                            
                            // ‚úÖ Dispatch event untuk notify system
                            window.dispatchEvent(new Event('profileModalClosed'));
                        }
                        
                        if (DEBUG) console.log('‚úÖ [SAVE] Modal switched, state reset');
                    }, 2000);
                } else {
                    if (DEBUG) console.log('‚ö†Ô∏è [SAVE] No changes were made');
                    showError('Tidak ada perubahan untuk disimpan');
                }

            } catch (error) {
                console.error('‚ùå [SAVE] Save profile error:', error);
                if (DEBUG) console.error('‚ùå [SAVE] Error details:', {
                    message: error.message,
                    stack: error.stack
                });
                showError(error.message || 'Gagal menyimpan profile');
            } finally {
                this.classList.remove('loading');
                this.textContent = 'SIMPAN';
                // console.log('üîÑ [SAVE] Button reset to normal state');
                // console.log('üíæ [SAVE] ========================================');
            }
        });
        // console.log('‚úÖ [EDIT-PROFILE] Save button listener added');
    }
    
    // console.log('‚úÖ [EDIT-PROFILE] All listeners initialized successfully!');
}; // End of initEditProfile function

// console.log('üöÄ [INIT-SCRIPT-LOADED] Edit profile script loaded!');
// console.log('üöÄ [INIT-SCRIPT-LOADED] typeof imageCompression:', typeof imageCompression);
// console.log('üöÄ [INIT-SCRIPT-LOADED] window.initEditProfile:', typeof window.initEditProfile);

// ============================================
// LOAD PROFILE DATA FROM DATABASE
// ============================================
window.loadProfileData = async function loadProfileData() {
    // console.log('üîÑ [PROFILE-LOAD] Loading profile data from database...');
    
    try {
        const token = getAuthToken();
        if (!token) {
            // console.log('‚ö†Ô∏è [PROFILE-LOAD] No auth token, skipping profile load');
            return;
        }

        const response = await fetch('https://profile-worker.nuranantoadhien.workers.dev/profile/me', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            console.error('‚ùå [PROFILE-LOAD] Failed to load profile:', response.status);
            return;
        }

        const data = await response.json();
        // console.log('üì¶ [PROFILE-LOAD] Profile data received:', data);

        if (data.success && data.profile) {
            const { displayName, avatarUrl } = data.profile;
            // console.log('üîç [PROFILE-LOAD] Extracted data - displayName:', displayName, 'avatarUrl:', avatarUrl);

            // Update profile username
            const profileUsername = document.getElementById('profileUsername');
            // console.log('üîç [PROFILE-LOAD] profileUsername element:', profileUsername);
            
            if (profileUsername) {
                if (displayName) {
                    profileUsername.textContent = displayName;
                    // console.log('‚úÖ [PROFILE-LOAD] Username updated to:', displayName);
                    // console.log('üîç [PROFILE-LOAD] Current username text:', profileUsername.textContent);
                }
                // else {
                //     console.warn('‚ö†Ô∏è [PROFILE-LOAD] displayName is empty or null');
                // }
            } else {
                console.error('‚ùå [PROFILE-LOAD] profileUsername element not found!');
            }

            // Update profile avatar
            const profileAvatar = document.querySelector('.profile-avatar');
            // console.log('üîç [PROFILE-LOAD] profileAvatar element:', profileAvatar);
            
            if (profileAvatar) {
                if (avatarUrl) {
                    profileAvatar.src = avatarUrl;
                    // console.log('‚úÖ [PROFILE-LOAD] Avatar updated to:', avatarUrl);
                }
                // else {
                //     console.warn('‚ö†Ô∏è [PROFILE-LOAD] avatarUrl is empty or null');
                // }
            } else {
                console.error('‚ùå [PROFILE-LOAD] profileAvatar element not found!');
            }

            // console.log('üéâ [PROFILE-LOAD] Profile load completed!');
        }
        // else {
        //     console.warn('‚ö†Ô∏è [PROFILE-LOAD] Invalid profile data:', data);
        // }
    } catch (error) {
        console.error('‚ùå [PROFILE-LOAD] Error loading profile:', error);
    }
}; // End of loadProfileData

// ============================================
// CHECK EDIT ELIGIBILITY & HIDE PENCIL IF RATE LIMITED
// ============================================
window.checkEditEligibility = async function() {
    // console.log('üîç [ELIGIBILITY] Checking edit eligibility...');
    
    try {
        const token = getAuthToken();
        if (!token) {
            // console.log('‚ö†Ô∏è [ELIGIBILITY] No auth token');
            return;
        }

        const response = await fetch('https://profile-worker.nuranantoadhien.workers.dev/profile/check-eligibility', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            console.error('‚ùå [ELIGIBILITY] Failed to check eligibility:', response.status);
            return;
        }

        const data = await response.json();
        // console.log('üì¶ [ELIGIBILITY] Response:', data);

        if (data.success) {
            const btnEditProfile = document.getElementById('btnEditProfile');
            
            // Hide pencil if BOTH avatar AND name are rate limited
            const isRateLimited = !data.avatar.canUpload && !data.name.canChange;
            
            if (btnEditProfile) {
                if (isRateLimited) {
                    btnEditProfile.classList.add('hidden');
                    // console.log('üö´ [ELIGIBILITY] Edit button hidden - rate limited for both avatar and name');
                    // console.log('   - Avatar available in:', data.avatar.remainingDays, 'days');
                    // console.log('   - Name available in:', data.name.remainingDays, 'days');
                } else {
                    btnEditProfile.classList.remove('hidden');
                    // console.log('‚úÖ [ELIGIBILITY] Edit button visible - editing available');
                }
            }
        }
    } catch (error) {
        console.error('‚ùå [ELIGIBILITY] Error checking eligibility:', error);
    }
};

// Load profile data when page loads (if user is logged in)
// Use window.addEventListener('load') to ensure common.js is loaded first
window.addEventListener('load', function() {
    // console.log('üîÑ [PROFILE-LOAD] Page fully loaded, checking auth status...');
    
    // Check if getAuthToken is available (from common.js)
    if (typeof getAuthToken === 'function') {
        const token = getAuthToken();
        if (token) {
            // console.log('üîê [PROFILE-LOAD] User is logged in, loading profile...');
            window.loadProfileData();
            window.checkEditEligibility(); // Check if edit button should be hidden
        } else {
            // console.log('‚ÑπÔ∏è [PROFILE-LOAD] No valid token found, skipping profile load');
        }
    }
    // else {
    //     console.warn('‚ö†Ô∏è [PROFILE-LOAD] getAuthToken() not available - common.js might not be loaded');
    // }
    
    // ========================================
    // üìä VIEW COUNTER - Cloudflare Worker Integration
    // ========================================
    const WORKER_URL = 'https://manga-view-counter.nuranantoadhien.workers.dev';
    
    // Get manga name from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const mangaRepo = urlParams.get('manga');
    
    if (mangaRepo) {
        // Increment manga view
        fetch(WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                repo: mangaRepo,
                type: 'page'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('‚úÖ Manga view recorded');
            } else if (data.cooldown) {
                console.log('‚è≥ View cooldown active');
            }
        })
        .catch(err => console.warn('‚ö†Ô∏è View counter error:', err));
    }
});
</script>

<!-- Scripts already loaded at line 380-383, duplicates removed -->
</body>
</html>
